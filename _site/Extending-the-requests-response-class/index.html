<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
　　<title>Extending the requests response class</title>
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/static/css/style.css"/>
    <link rel="stylesheet" href="/static/css/solarized_light.css">
    <script src="/static/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      jax: ["input/TeX", "output/HTML-CSS"],
      tex2jax: {
        inlineMath: [ ['$', '$'] ],
        displayMath: [ ['$$', '$$']],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      },
      messageStyle: "none",
      "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
    });
    </script>
    <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
    <script src="/static/js/jquery-2.1.3.min.js"></script>
    <script src="/static/js/script.js"></script>
　</head>

　<body>
    <div id="wrapper">
      <aside>
        <div class="site-info">lastmayday</div>
        <div class="index">
          <a href="/"><div class="circle home"><span>Home</span></div></a>
          <a href="/blog"><div class="circle blog"><span>Blog</span></div></a>
          <a href="/about.html"><div class="circle about"><span>About</span></div></a>
          <a href="/link.html"><div class="circle link"><span>Link</span></div></a>
        </div>
      </aside>
      <div class="content" role="main">
          <h1>Extending the requests response class</h1>
          <div class="info">21 March 2014</div>
          <br />
          <p><a href="http://jakeaustwick.me/extending-the-requests-response-class/">原文地址</a></p>

<p><br /></p>

<p>Requests 是一个奇妙的 Python 库, 也是我这些天用得最舒服的几个库之一. 我每天都用它主要是因为我的<a href="http://jakeaustwick.me/python-web-scraping-resource/">爬虫</a>.</p>

<p><br /></p>

<p>在你的爬虫项目中, 你可能会用到一些很简便的函数, 而且你可能刚刚复制了这些函数并把你的 response 对象作为参数传给它们. <strong>我们可以做得更好</strong>.</p>

<p><br /></p>

<p>我将会演示怎样给 <code>Response</code> 类增加一些简单的方法, 这样你可以在你自己的项目中用你自己的方法来使用这个技巧.</p>

<p><br /></p>

<p>我们从定义一个 <code>Response</code> 类开始, 这个类有几个简单的方法. 最重要的方法是 <code>doc()</code>. 它”获得”解析过的 HTML 语法树, 这样我们其他的方法就不用在每次调用的时候都重新解析一遍 HTML.</p>

<pre>
<code class="python">
import requests
from lxml import html
import inspect

class Response(object):
    def doc(self):
        if not hasattr(self, '_doc'):
            self._doc = html.fromstring(self.text)
        return self._doc

    def links(self):
        return self.doc().xpath('//a/@href')

    def images(self, filter_extensions=['jpg', 'jpeg', 'gif', 'png']):
        return [link for link in self.doc().xpath('//img/@src') if link.endswith(tuple(filter_extensions))]

    def title(self):
        title = self.doc().xpath('//title/text()')
        if len(title):
            return title[0].strip()
        else:
            return None
</code>
</pre>

<p><br /></p>

<p>现在, 我们需要用我们新定义的类来修补 <code>requests.Response</code> 类. 我们将使用来自 <a href="http://docs.python.org/2/library/inspect.html">inspect 模块</a> 的 <a href="http://docs.python.org/2/library/inspect.html#inspect.getmembers">getmember()</a> 函数, 并把 <a href="http://docs.python.org/2/library/inspect.html#inspect.ismethod">ismethod()</a> 作为参数.</p>

<pre>
<code class="python">
for method_name, method in inspect.getmembers(Response, inspect.ismethod):  
    setattr(requests.models.Response, method_name, method.im_func)
</code>
</pre>

<p><br /></p>

<p>这样就完成啦. 现在你可以对任何 reponse 对象使用这些简便的函数, 看下面这个例子:</p>

<pre>
<code class="python">
r = requests.get('http://imgur.com/')
print r.title()
print r.images(filter_extensions=['png'])
</code>
</pre>

<p><br /></p>

<p>现在我们继续, 把你的 response 对象变得向你想要的一样强大吧. 如果你对其他的爬虫技巧有兴趣, 可以看下我的<a href="http://jakeaustwick.me/extending-the-requests-response-class/jakeaustwick.me/python-web-scraping-resource/">python web scraping resource</a>.</p>

<p><br /></p>

<hr />

<p><br /></p>

<h3 id="section">翻译完毕下面是自己的瞎说</h3>

<p><br /></p>

<p>第一次看到 inspect 模块的用法.</p>

<p>原文很短英文也不难所以推荐直接读原文, 之所以翻译了一下是觉得这文章确实很有意思~</p>

<p><br /></p>


          
          <div class="tags">
            <span>标签: </span>
            <ul>
            
              <li>Python</li>
            
            </ul>
          </div>
          
          <div id="disqus_thread"></div>
          <script type="text/javascript">
            var disqus_shortname = 'lastmayday-github'; // required: replace example with your forum shortname
            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
      <footer role="contentinfo">
        <p>Powered by <a href="http://jekyllrb.com/">Jekyll</a> and <a href="http://pages.github.com/">Github Pages</a></p>
        <p> &copy lastmayday 2013-2015 | All Rights Reserved. </p>
      </footer>
    </div>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-38333678-2']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
