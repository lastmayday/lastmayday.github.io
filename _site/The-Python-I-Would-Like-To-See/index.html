<!DOCTYPE html>
<html>
  <head>
　　 <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
　　 <title>
               The Python I Would Like To See
           
    </title>
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/static/css/style.css"/>
    <link rel="stylesheet" href="/static/css/solarized_light.css">
    <script src="/static/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      jax: ["input/TeX", "output/HTML-CSS"],
      tex2jax: {
        inlineMath: [ ['$', '$'] ],
        displayMath: [ ['$$', '$$']],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      },
      messageStyle: "none",
      "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
    });
    </script>
    <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
　</head>

　<body>
    <div id="wrapper">
      <aside>
        <div class="site-info">lastmayday</div>
        <div class="index">
          <a href="/"><div class="circle home"><span>Home</span></div></a>
          <a href="/blog"><div class="circle blog"><span>Blog</span></div></a>
          <a href="/about.html"><div class="circle about"><span>About</span></div></a>
          <a href="/link.html"><div class="circle link"><span>Link</span></div></a>
        </div>
      </aside>
      <div class="content" role="main">
          <h1>The Python I Would Like To See</h1>
          <div class="info">04 September 2014</div>
          <br />
          <p><a href="http://lucumr.pocoo.org/2014/8/16/the-python-i-would-like-to-see/">原文地址</a></p>

<p><br /></p>

<p>众所周知我不喜欢 Python 3 以及 Python 现在的发展趋势. 这使得我在过去的几个月中收到了一大堆邮件问我, 我喜欢的 Python 是什么样儿的. 所以我觉得可能需要分享一下我的想法, 这样可能会给以后的语言设计者提供一些想法 :)</p>

<p><br /></p>

<p>Python 显然不是一个完美的语言. 然而, 我认为让我感到沮丧的是这个语言的最大问题是, 不得不在解释器中处理细节问题而只有少量是在语言本身处理. 然而这些解释器的细节正在成为 Python 的一部分, 这也是它们为什么重要的原因.</p>

<p><br /></p>

<p>我会从解释器(插槽)的一个小怪癖开始, 然后在语言设计的最大错误结束. 如果这样写的效果不错的话, 以后会有更多这样写的文章.</p>

<p><br /></p>

<p>大体上看, 这些文章会探索解释器中的设计决策以及这样对于解释器和最后的语言有什么结果. 我相信这个一般的语言设计观点比推荐怎样深入 Python 更有趣.</p>

<p><br /></p>

<h2 id="language-vs-implementation--vs-">Language vs Implementation 语言 vs 应用</h2>

<p><br /></p>

<p>在我写了这篇文章的初始版本后添加了这个特殊的段落, 因为我认为 Python 作为语言以及 CPython 作为解释器并没有开发者可能认为的那样分离. 这儿有一个语言规范, 但是很多情况下, 它只是编纂了解释器做什么或者解释器缺少什么.</p>

<p><br /></p>

<p>在这种特殊的情况下, 解释器的这个晦涩的应用细节改变或者影响了语言的设计, 并且也强迫其他的 Python 应用采用它. 例如, (我假设) PyPy 并不知道有关插槽的任何东西, 但是它仍然不得不像插槽是解释器的一部分那样操作.</p>

<p><br /></p>

<h2 id="slots-">Slots 插槽</h2>

<p><br /></p>

<p>到目前为止, 我对这个语言最大的问题就是愚蠢的插槽系统. 我不是指<code>__slots__</code>而是给特殊方法的内部类型插槽. 这些插槽是这个语言的”特性”, 这是个很大的误解, 因为这些东西你几乎不会去考虑它. 也就是说, 我认为插槽的存在是这个语言的最大的问题.</p>

<p><br /></p>

<p>那么插槽是什么呢? 一个插槽是解释器怎么被内部应用的副作用. 每一个 Python 开发者都知道” dunder 方法”: 类似<code>__add__</code>. 这些方法以两个下划线开头, 然后是这个特殊方法的名字, 然后再是两个下划线. 就像每个开发者知道的, <code>a + b</code>就像<code>a.__add__(b)</code>.</p>

<p><br /></p>

<p>不幸的是, 这是个谎言.</p>

<p><br /></p>

<p>Python 实际上并不是那样工作的. Python 内部实际上一点儿也不是那样工作的(目前来说). 相反, 下面是对解释器怎样工作的一个简述:</p>

<ol>
  <li>
    <p>当一个类型被创建, 解释器会找到类里的所有描述, 并且寻找类似<code>__add__</code>的特殊方法.</p>
  </li>
  <li>
    <p>对解释器找到的每一个特殊方法, 它把一个引用描述成对象类型预定义的插槽. 例如, 特殊方法<code>__add__</code>对应两个内部插槽: <code>tp_as_number-&gt;nb_add</code>和<code>tp_as_sequence-&gt;sq_concat</code>.</p>
  </li>
  <li>
    <p>当解释器想要计算<code>a + b</code>的时候, 它会调用类似<code>TYPE_OF(a)-&gt;tp_as_number-&gt;nb_add(a, b)</code>这样的方法(实际上比这个更加复杂, 因为<code>__add__</code>实际上有很多个插槽).</p>
  </li>
</ol>

<p><br /></p>

<p>所以表面上<code>a + b</code>做的事情看上去像<code>type(a).__add__(a, b)</code>, 但正如你从插槽处理看到的, 即使这样也是不对的. 你可以很容易地验证它, 通过在一个元类中应用<code>__getattribute__</code>并且尝试 hook 一个自定义的<code>__add__</code>方法. 你会发现它从来没有被调用.</p>

<p><br /></p>

<p>我认为这个插槽系统是完全荒谬的. 它对于解释器中的某些特殊类型(例如整型)是一种优化, 但是对于其他类型是完全没有意义的.</p>

<p><br /></p>

<p>为了展示这个, 考虑这个完全没有意义的类型(<code>x.py</code>):</p>
<pre>
<code class="python">
class A(object):
    def __add__(self, other):
        return 42
</code>
</pre>

<p><br /></p>

<p>因为我们有<code>__add__</code>方法所以解释器会在一个插槽中设置它. 那么它可以多块呢? 当我们执行<code>a + b</code>的时候, 我们使用这些插槽, 所以这里是它执行的时间:</p>
<pre>
<code class="python">
$ python3 -mtimeit -s 'from x import A; a = A(); b = A()' 'a + b'
1000000 loops, best of 3: 0.256 usec per loop
</code>
</pre>

<p><br /></p>

<p>如果我们绕开插槽系统直接调用<code>a.__add__(b)</code>. 相反, 解释器会在实例字典中寻找(但是找不到任何东西)然后在类型的字典中寻找并且会找到这个方法. 下面是这个花费的时间:</p>
<pre>
<code class="python">
$ python3 -mtimeit -s 'from x import A; a = A(); b = A()' 'a.__add__(b)'
10000000 loops, best of 3: 0.158 usec per loop
</code>
</pre>

<p><br /></p>

<p>你能相信吗: 没有插槽的版本实际上更快. 这是什么魔法? 我并不十分确定这个原因, 但是这样的情况已经存在很久了. 实际上, 旧式类(没有插槽)比新式类更快并且有更多的特性.</p>

<p><br /></p>

<p>更多特性? 似的, 因为旧式类可以这样做(Python 2.7):</p>
<pre>
<code class="python">
&gt;&gt;&gt; original = 42
&gt;&gt;&gt; class FooProxy:
...  def __getattr__(self, x):
...   return getattr(original, x)
...
&gt;&gt;&gt; proxy = FooProxy()
&gt;&gt;&gt; proxy
42
&gt;&gt;&gt; 1 + proxy
43
&gt;&gt;&gt; proxy + 1
43
</code>
</pre>

<p><br /></p>


          
          <div class="tags">
            <span>标签: </span>
            <ul>
            
              <li>Python</li>
            
            </ul>
          </div>
          
          <div id="disqus_thread"></div>
          <script type="text/javascript">
            var disqus_shortname = 'lastmayday-github'; // required: replace example with your forum shortname
            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
      <footer role="contentinfo">
        <p>Powered by <a href="http://jekyllrb.com/">Jekyll</a> and <a href="http://pages.github.com/">Github Pages</a></p>
        <p> &copy lastmayday 2013-2014 | All Rights Reserved. </p>
      </footer>
    </div>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-38333678-2']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
